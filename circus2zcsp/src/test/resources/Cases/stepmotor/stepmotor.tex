\documentclass{article}
%
\usepackage{circus}
%
\begin{document}

\begin{zsection}
	\SECTION\ stepmotor \parents\ circus\_toolkit
\end{zsection}

\begin{zed}
	MAXPOS == 3000  \\
	RANGE == 0 .. MAXPOS 
\end{zed}

\begin{circus}
	\circchannel\ fwd, bwd\\
	\circchannel\ out : RANGE
\end{circus}

\begin{circus}
	\circprocess\ StepMotor \circdef \circbegin \\
    	\t1 \circstate\ SMState == [~ pos: RANGE ~] \\
    	\t1	SMInit == [~ (SMState)' | pos' = 0 ~] \\
		\t1 MoveForward == [~ \Delta SMState | pos < MAXPOS \land pos' = (pos + 1) ~] \\
		\t1 MoveFWError == [~ \Delta SMState | pos = MAXPOS \land pos' = pos ~] \\
		\t1 MoveBackward== [~ \Delta SMState | pos > 0 \land pos' = (pos - 1) ~] \\
		\t1 MoveBWError == [~ \Delta SMState | pos = 0 \land pos' = pos ~] \\
		\t1 Run \circdef (
			(fwd \then  (MoveForward \extchoice MoveFWError))
			\extchoice
			(bwd \then  (MoveBackward \extchoice MoveBWError))
			\extchoice 
			(out!pos \then \Skip)
		) \\
	\t1 \circspot SMInit \circseq (\circmu X \circspot (Run \circseq X)) \\
	\circend
\end{circus}

\end{document}
